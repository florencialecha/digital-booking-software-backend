stages:
  - deploy

deploy:
  stage: deploy
  variables:
    SSH_PRIVATE_KEY: $6KeyPair
  before_script:
    - apt-get update && apt-get install -y openssh-client
    - mkdir -p /root/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > /root/.ssh/id_rsa
    - chmod 600 /root/.ssh/id_rsa
    - /home/ubuntu/openssh/bin/ssh-keyscan -H 3.131.138.206 >> /root/.ssh/known_hosts
  script:
    - echo "Building and packaging code"
    - mvn clean package
    - echo "Copying JAR file to EC2 instance"
    - sudo scp -i /root/.ssh/id_rsa target/back.jar ubuntu@3.131.138.206:/home/ubuntu/jarFolder/
    - echo "Restarting ApiBack.service"
    - sudo ssh -i /root/.ssh/id_rsa ubuntu@3.131.138.206 "sudo systemctl restart ApiBack.service"
